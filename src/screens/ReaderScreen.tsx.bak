/**
 * Copyright (c) 2025 RÃ©pÃ©t Contributors
 * Licensed under the MIT License
 * See LICENSE file in the project root for full license text
 */

import { useEffect, useState } from 'react'
import { useNavigate, useParams } from 'react-router-dom'
import { usePlayStore } from '../state/playStore'
import { useSettingsStore } from '../state/settingsStore'
import { useUIStore } from '../state/uiStore'
import {
  useCurrentLine,
  useCanGoNext,
  useCanGoPrevious,
  useCurrentSceneLines,
} from '../state/selectors'
import { playsRepository } from '../core/storage/plays'
import { ttsEngine } from '../core/tts'
import { Button } from '../components/common/Button'
import { Spinner } from '../components/common/Spinner'
import type { Line } from '../core/models/Line'

/**
 * Ã‰cran de lecture focalisÃ©e (mode lecteur)
 * Affiche uniquement les lignes du personnage sÃ©lectionnÃ©
 */
export function ReaderScreen() {
  const { playId } = useParams<{ playId: string }>()
  const navigate = useNavigate()

  // State
  const {
    currentPlay,
    userCharacter,
    currentLineIndex,
    loadPlay,
    nextLine,
    previousLine,
    goToLine,
    closePlay,
  } = usePlayStore()

  const { speed, volume, selectedVoice, highlightUserLines, readingMode, hideUserLinesInItalian } =
    useSettingsStore()
  const { startLoading, stopLoading, addError } = useUIStore()

  const currentLine = useCurrentLine()
  const canGoNext = useCanGoNext()
  const canGoPrevious = useCanGoPrevious()
  const sceneLines = useCurrentSceneLines()

  const [isPlaying, setIsPlaying] = useState(false)
  const [showAllLines, setShowAllLines] = useState(false)
  const [revealLine, setRevealLine] = useState(false)

  // Charger la piÃ¨ce au montage
  useEffect(() => {
    if (!playId) {
      navigate('/library')
      return
    }

    const loadPlayData = async () => {
      startLoading()
      try {
        const play = await playsRepository.get(playId)
        if (!play) {
          addError('PiÃ¨ce non trouvÃ©e')
          navigate('/library')
          return
        }
        loadPlay(play)
      } catch (error) {
        console.error('Error loading play:', error)
        addError('Erreur lors du chargement de la piÃ¨ce')
        navigate('/library')
      } finally {
        stopLoading()
      }
    }

    loadPlayData()
  }, [playId, navigate, loadPlay, startLoading, stopLoading, addError])

  // Nettoyer TTS au dÃ©montage
  useEffect(() => {
    return () => {
      ttsEngine.stop()
    }
  }, [])

  // Handlers
  const handlePlayLine = async (line: Line) => {
    if (isPlaying || !line.text) return

    setIsPlaying(true)
    try {
      ttsEngine.speak({
        text: line.text,
        voiceURI: selectedVoice ?? undefined,
        rate: speed,
        volume: volume,
        lineId: line.id,
      })
    } catch (error) {
      console.error('TTS error:', error)
      addError('Erreur de lecture vocale')
    } finally {
      setIsPlaying(false)
    }
  }

  const handleStopPlaying = () => {
    ttsEngine.stop()
    setIsPlaying(false)
  }

  const handleNext = () => {
    if (isPlaying) {
      handleStopPlaying()
    }
    setRevealLine(false)
    nextLine()
  }

  const handlePrevious = () => {
    if (isPlaying) {
      handleStopPlaying()
    }
    setRevealLine(false)
    previousLine()
  }

  const handleGoToLine = (index: number) => {
    if (isPlaying) {
      handleStopPlaying()
    }
    setRevealLine(false)
    goToLine(index)
  }

  const handleClose = () => {
    if (isPlaying) {
      handleStopPlaying()
    }
    closePlay()
    navigate('/library')
  }

  // Filtrer les lignes du personnage si mode focus activÃ©
  const displayLines = showAllLines
    ? sceneLines
    : sceneLines.filter((line) => !userCharacter || line.characterId === userCharacter.id)

  // Mode italiennes : masquer les lignes de l'utilisateur
  const isItalianMode = readingMode === 'italian'
  const shouldHideCurrentLine = !!(
    isItalianMode &&
    hideUserLinesInItalian &&
    userCharacter &&
    currentLine?.characterId === userCharacter.id &&
    !revealLine
  )

  // Rendu
  if (!currentPlay) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Spinner size="lg" />
      </div>
    )
  }

  if (!userCharacter) {
    return (
      <div className="flex flex-col items-center justify-center min-h-screen p-4">
        <div className="text-center">
          <h2 className="text-2xl font-bold text-gray-900 mb-4">Personnage non sÃ©lectionnÃ©</h2>
          <p className="text-gray-600 mb-6">
            Veuillez sÃ©lectionner votre personnage pour utiliser le mode lecteur.
          </p>
          <Button onClick={() => navigate(`/play/${playId}`)}>Retour Ã  la lecture</Button>
        </div>
      </div>
    )
  }

  return (
    <div className="flex flex-col h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white border-b border-gray-200 px-4 py-3">
        <div className="flex items-center justify-between max-w-4xl mx-auto">
          <div className="flex items-center gap-4">
            <Button variant="secondary" onClick={handleClose}>
              â† Retour
            </Button>
            <div>
              <div className="flex items-center gap-2">
                <h1 className="text-xl font-bold text-gray-900">{currentPlay.title}</h1>
                {isItalianMode && (
                  <span className="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded font-semibold">
                    MODE ITALIENNES
                  </span>
                )}
              </div>
              <p className="text-sm text-gray-600">Mode Lecteur - {userCharacter.name}</p>
            </div>
          </div>
          <Button variant="secondary" onClick={() => setShowAllLines(!showAllLines)}>
            {showAllLines ? 'Mes lignes' : 'Toutes les lignes'}
          </Button>
        </div>
      </header>

      {/* Main content */}
      <div className="flex-1 overflow-hidden flex flex-col max-w-4xl mx-auto w-full">
        {/* Current line highlight */}
        {currentLine && (
          <div className="bg-blue-50 border-b border-blue-200 px-4 py-6">
            <div className="text-sm text-blue-600 font-semibold mb-2">Ligne actuelle</div>
            <div className="text-lg font-medium text-gray-900 mb-2">
              {currentLine.characterId
                ? currentPlay.characters.find((c) => c.id === currentLine.characterId)?.name ||
                  'Didascalie'
                : 'Didascalie'}
            </div>
            <div
              className={`text-gray-800 text-xl leading-relaxed mb-4 ${
                shouldHideCurrentLine ? 'blur-sm select-none' : ''
              }`}
            >
              {shouldHideCurrentLine ? 'â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—' : currentLine.text}
            </div>
            <div className="flex gap-2">
              <Button
                onClick={() => handlePlayLine(currentLine)}
                disabled={isPlaying || !currentLine.text || shouldHideCurrentLine}
              >
                {isPlaying ? 'ğŸ”Š Lecture...' : shouldHideCurrentLine ? 'ğŸ”’ MasquÃ©' : 'â–¶ Lire'}
              </Button>
              {isPlaying && (
                <Button variant="secondary" onClick={handleStopPlaying}>
                  â¹ ArrÃªter
                </Button>
              )}
            </div>

            {/* Reveal button for Italian mode */}
            {isItalianMode &&
              hideUserLinesInItalian &&
              userCharacter &&
              currentLine?.characterId === userCharacter.id && (
                <div className="mt-4 text-center border-t border-blue-200 pt-4">
                  <Button
                    variant={revealLine ? 'secondary' : 'primary'}
                    onClick={() => setRevealLine(!revealLine)}
                  >
                    {revealLine ? 'ğŸ”’ Masquer Ã  nouveau' : 'ğŸ‘ï¸ RÃ©vÃ©ler ma rÃ©plique'}
                  </Button>
                  <p className="mt-2 text-xs text-blue-600">
                    {revealLine
                      ? 'Vous pouvez masquer Ã  nouveau pour rÃ©pÃ©ter'
                      : 'Cliquez pour voir votre rÃ©plique si nÃ©cessaire'}
                  </p>
                </div>
              )}
          </div>
        )}

        {/* Lines list */}
        <div className="flex-1 overflow-y-auto px-4 py-4">
          <div className="space-y-3">
            {displayLines.length > 0 ? (
              displayLines.map((line) => {
                const isCurrentLine = currentPlay.lines.indexOf(line) === currentLineIndex
                const isUserLine = line.characterId === userCharacter.id
                const shouldHideLine =
                  isItalianMode && hideUserLinesInItalian && isUserLine && !showAllLines

                return (
                  <div
                    key={`${line.actIndex}-${line.sceneIndex}-${currentPlay.lines.indexOf(line)}`}
                    className={`
                      p-4 rounded-lg border cursor-pointer transition-all
                      ${
                        isCurrentLine
                          ? 'bg-blue-100 border-blue-400 shadow-md'
                          : 'bg-white border-gray-200 hover:bg-gray-50'
                      }
                      ${isUserLine && highlightUserLines ? 'border-l-4 border-l-green-500' : ''}
                    `}
                    onClick={() => handleGoToLine(currentPlay.lines.indexOf(line))}
                  >
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <div className="text-sm font-semibold text-gray-900 mb-1">
                          {line.characterId
                            ? currentPlay.characters.find((c) => c.id === line.characterId)?.name ||
                              'Didascalie'
                            : 'Didascalie'}
                          {isUserLine && (
                            <span className="ml-2 text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded">
                              Vous
                            </span>
                          )}
                        </div>
                        <div
                          className={`text-gray-700 ${shouldHideLine ? 'blur-sm select-none' : ''}`}
                        >
                          {shouldHideLine ? 'â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—' : line.text}
                        </div>
                      </div>
                      <button
                        onClick={(e) => {
                          e.stopPropagation()
                          handlePlayLine(line)
                        }}
                        disabled={isPlaying || !line.text || shouldHideLine}
                        className="ml-4 text-blue-600 hover:text-blue-800 disabled:text-gray-400"
                        title={shouldHideLine ? 'Ligne masquÃ©e en mode italien' : 'Lire la ligne'}
                      >
                        {shouldHideLine ? 'ğŸ”’' : 'â–¶'}
                      </button>
                    </div>
                  </div>
                )
              })
            ) : (
              <div className="text-center text-gray-500 mt-8">
                Aucune ligne Ã  afficher dans cette scÃ¨ne
              </div>
            )}
          </div>
        </div>

        {/* Navigation Controls */}
        <div className="bg-white border-t border-gray-200 px-4 py-4">
          <div className="flex items-center justify-between">
            <Button variant="secondary" onClick={handlePrevious} disabled={!canGoPrevious}>
              â† PrÃ©cÃ©dent
            </Button>
            <div className="text-sm text-gray-600">
              Ligne {currentLineIndex + 1} / {currentPlay.lines.length}
            </div>
            <Button variant="secondary" onClick={handleNext} disabled={!canGoNext}>
              Suivant â†’
            </Button>
          </div>
        </div>
      </div>
    </div>
  )
}
