<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Piper Phonemize</title>
    <style>
        body {
            font-family: monospace;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        #log {
            background: #f5f5f5;
            padding: 20px;
            border: 1px solid #ccc;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 12px;
        }
        button {
            padding: 10px 20px;
            margin: 10px 5px;
            font-size: 14px;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .warn { color: orange; }
        input {
            width: 400px;
            padding: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Test Piper Phonemize WASM</h1>

    <div></div>
        <button onclick="testInit()">1. Initialize Module</button>
        <button onclick="testFS()">2. Check Filesystem</button>
        <button onclick="testPhonemize()">3. Test Phonemize</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div>
        <label>Text to phonemize:</label><br>
        <input type="text" id="testText" value="Bonjour le monde" />
        <label>Voice:</label>
        <input type="text" id="testVoice" value="fr" style="width: 50px;" />
    </div>

    <div id="log"></div>

    <script>
        let module = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function testInit() {
            log('=== INITIALISATION DU MODULE ===', 'info');

            try {
                // Charger le script
                log('Chargement de piper_phonemize.js...', 'info');
                const script = document.createElement('script');
                script.src = '/wasm/piper_phonemize.js';

                await new Promise((resolve, reject) => {
                    script.onload = () => {
                        log('✓ Script chargé', 'success');
                        resolve();
                    };
                    script.onerror = () => {
                        log('✗ Erreur de chargement du script', 'error');
                        reject(new Error('Échec du chargement'));
                    };
                    document.head.appendChild(script);
                });

                // Vérifier que la fonction est disponible
                if (!window.createPiperPhonemize) {
                    log('✗ createPiperPhonemize non trouvé dans window', 'error');
                    return;
                }
                log('✓ createPiperPhonemize disponible', 'success');

                // Créer le module
                log('Création du module WASM...', 'info');
                module = await window.createPiperPhonemize({
                    locateFile: (path) => {
                        log(`locateFile: ${path}`, 'info');
                        if (path.endsWith('.wasm')) {
                            return '/wasm/piper_phonemize.wasm';
                        }
                        if (path.endsWith('.data')) {
                            return '/wasm/piper_phonemize.data';
                        }
                        return path;
                    },
                    print: (text) => {
                        log(`[stdout] ${text}`, 'info');
                    },
                    printErr: (text) => {
                        log(`[stderr] ${text}`, 'error');
                    },
                    onRuntimeInitialized: () => {
                        log('✓ Runtime WASM initialisé', 'success');
                    }
                });

                log('✓ Module créé', 'success');

                // Attendre que le .data soit chargé
                log('Attente du chargement du .data...', 'info');
                await new Promise((resolve) => {
                    let attempts = 0;
                    const check = () => {
                        attempts++;
                        if (module.FS) {
                            log(`✓ FS disponible après ${attempts} tentatives`, 'success');
                            resolve();
                        } else {
                            if (attempts < 100) {
                                setTimeout(check, 50);
                            } else {
                                log('✗ Timeout: FS non disponible', 'error');
                                resolve();
                            }
                        }
                    };
                    check();
                });

            } catch (error) {
                log(`✗ Erreur: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function testFS() {
            log('=== VÉRIFICATION DU SYSTÈME DE FICHIERS ===', 'info');

            if (!module) {
                log('✗ Module non initialisé', 'error');
                return;
            }

            if (!module.FS) {
                log('✗ FS non disponible', 'error');
                return;
            }

            log('✓ FS disponible', 'success');

            // Vérifier /espeak-ng-data
            try {
                const espeakPath = module.FS.analyzePath('/espeak-ng-data');
                log(`/espeak-ng-data exists: ${espeakPath.exists}`, espeakPath.exists ? 'success' : 'error');

                if (espeakPath.exists) {
                    const contents = module.FS.readdir('/espeak-ng-data');
                    log(`Contenu de /espeak-ng-data (${contents.length} items):`, 'info');
                    contents.slice(0, 20).forEach(item => {
                        log(`  - ${item}`, 'info');
                    });
                    if (contents.length > 20) {
                        log(`  ... et ${contents.length - 20} autres`, 'info');
                    }

                    // Vérifier lang
                    const langPath = module.FS.analyzePath('/espeak-ng-data/lang');
                    log(`/espeak-ng-data/lang exists: ${langPath.exists}`, langPath.exists ? 'success' : 'error');

                    // Vérifier fr_dict
                    const frDictPath = module.FS.analyzePath('/espeak-ng-data/fr_dict');
                    log(`/espeak-ng-data/fr_dict exists: ${frDictPath.exists}`, frDictPath.exists ? 'success' : 'error');
                }
            } catch (error) {
                log(`✗ Erreur lors de la vérification: ${error.message}`, 'error');
                console.error(error);
            }

            // Créer /tmp si nécessaire
            try {
                module.FS.mkdir('/tmp');
                log('✓ /tmp créé', 'success');
            } catch (error) {
                log(`/tmp existe déjà ou erreur: ${error.message}`, 'warn');
            }
        }

        async function testPhonemize() {
            log('=== TEST DE PHONEMIZATION ===', 'info');

            if (!module) {
                log('✗ Module non initialisé', 'error');
                return;
            }

            const text = document.getElementById('testText').value;
            const voice = document.getElementById('testVoice').value;

            log(`Texte: "${text}"`, 'info');
            log(`Voix: "${voice}"`, 'info');

            try {
                // Créer des fichiers temporaires
                const inputPath = '/tmp/test_input.txt';
                const outputPath = '/tmp/test_output.txt';

                log(`Écriture dans ${inputPath}...`, 'info');
                module.FS.writeFile(inputPath, text);
                log('✓ Fichier écrit', 'success');

                // Préparer les arguments
                const args = [
                    'piper_phonemize',
                    '--espeak_data',
                    '/espeak-ng-data',
                    '--voice',
                    voice,
                    '--input',
                    inputPath,
                    '--output',
                    outputPath
                ];

                log(`Arguments: ${args.slice(1).join(' ')}`, 'info');

                // Appeler le programme
                log('Appel de callMain...', 'info');
                const exitCode = module.callMain(args);
                log(`Code de sortie: ${exitCode}`, exitCode === 0 ? 'success' : 'error');

                if (exitCode === 0) {
                    // Lire le résultat
                    log(`Lecture de ${outputPath}...`, 'info');
                    const phonemes = module.FS.readFile(outputPath, { encoding: 'utf8' });
                    log(`✓ Résultat: "${phonemes}"`, 'success');
                } else {
                    log(`✗ Échec de la phonemization (code ${exitCode})`, 'error');
                }

                // Nettoyer
                try {
                    module.FS.unlink(inputPath);
                    module.FS.unlink(outputPath);
                    log('✓ Fichiers temporaires nettoyés', 'success');
                } catch (e) {
                    log(`Nettoyage: ${e.message}`, 'warn');
                }

            } catch (error) {
                log(`✗ Erreur: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // Auto-log
        log('Page chargée. Commencez par cliquer sur "1. Initialize Module"', 'info');
    </script>
</body>
</html>
