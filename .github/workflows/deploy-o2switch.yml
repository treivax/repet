name: Deploy to O2switch

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # ==========================================
  # JOB 1: Build et d√©ployer OFFLINE
  # ==========================================
  deploy-offline:
    name: üöÄ Deploy Offline Build
    runs-on: ubuntu-latest

    steps:
      - name: ‚úÖ Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì• Install dependencies
        run: npm ci

      - name: üîç Type check
        run: npm run type-check

      - name: üßπ Lint
        run: npm run lint

      - name: üèóÔ∏è Build OFFLINE
        run: npm run build:offline
        env:
          NODE_ENV: production

      - name: üìä Check build size
        run: |
          echo "üì¶ Offline build size:"
          du -sh dist-offline/
          echo ""
          echo "Top 10 largest files/folders:"
          du -sh dist-offline/* | sort -rh | head -10

      - name: üìù Copy .htaccess for offline build
        run: |
          cat > dist-offline/.htaccess << 'EOF'
          # .htaccess for R√©p√©t Offline Build (app.repet.ecanasso.org)
          # This configuration ensures proper headers for PWA, WASM, and security

          # ====================================
          # 1. SECURITY & WASM/PWA HEADERS
          # ====================================

          <IfModule mod_headers.c>
              # Required headers for SharedArrayBuffer and threaded WASM
              Header set Cross-Origin-Embedder-Policy "credentialless"
              Header set Cross-Origin-Opener-Policy "same-origin"

              # General security headers
              Header set X-Content-Type-Options "nosniff"
              Header set X-Frame-Options "DENY"
              Header set X-XSS-Protection "1; mode=block"
              Header set Referrer-Policy "strict-origin-when-cross-origin"

              # Service Worker - no cache, always fresh
              <FilesMatch "sw\.js$">
                  Header set Cache-Control "public, max-age=0, must-revalidate"
                  Header set Service-Worker-Allowed "/"
              </FilesMatch>

              # Workbox - no cache
              <FilesMatch "workbox-.*\.js$">
                  Header set Cache-Control "public, max-age=0, must-revalidate"
              </FilesMatch>

              # PWA Manifest
              <FilesMatch "manifest\.webmanifest$">
                  Header set Content-Type "application/manifest+json"
                  Header set Cache-Control "public, max-age=86400"
              </FilesMatch>

              # Aggressive cache for hashed assets (immutable)
              <FilesMatch "\.(js|css|woff2|png|jpg|svg)$">
                  Header set Cache-Control "public, max-age=31536000, immutable"
              </FilesMatch>

              # Cache for voice models (.onnx files - large files)
              <FilesMatch "\.onnx$">
                  Header set Content-Type "application/octet-stream"
                  Header set Cache-Control "public, max-age=31536000, immutable"
              </FilesMatch>

              # Cache for voice model configs
              <FilesMatch "\.onnx\.json$">
                  Header set Content-Type "application/json"
                  Header set Cache-Control "public, max-age=31536000, immutable"
              </FilesMatch>

              # WASM files
              <FilesMatch "\.wasm$">
                  Header set Content-Type "application/wasm"
                  Header set Cache-Control "public, max-age=31536000, immutable"
              </FilesMatch>

              # MJS (ES Module) files
              <FilesMatch "\.mjs$">
                  Header set Content-Type "application/javascript"
                  Header set Cache-Control "public, max-age=31536000, immutable"
              </FilesMatch>

              # Data files for WASM
              <FilesMatch "\.data$">
                  Header set Content-Type "application/octet-stream"
                  Header set Cache-Control "public, max-age=31536000, immutable"
              </FilesMatch>
          </IfModule>

          # ====================================
          # 2. COMPRESSION (GZIP/BROTLI)
          # ====================================

          <IfModule mod_deflate.c>
              AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript
              AddOutputFilterByType DEFLATE application/javascript application/json
              AddOutputFilterByType DEFLATE application/manifest+json
              # Note: WASM compression is handled by the server if mod_brotli is enabled
          </IfModule>

          # ====================================
          # 3. SINGLE PAGE APPLICATION (SPA)
          # ====================================

          <IfModule mod_rewrite.c>
              RewriteEngine On
              RewriteBase /

              # Don't rewrite files that exist
              RewriteCond %{REQUEST_FILENAME} !-f
              RewriteCond %{REQUEST_FILENAME} !-d

              # Redirect all routes to index.html (SPA routing)
              RewriteRule ^ index.html [L]
          </IfModule>

          # ====================================
          # 4. MIME TYPES
          # ====================================

          <IfModule mod_mime.c>
              AddType application/wasm .wasm
              AddType application/javascript .mjs
              AddType application/manifest+json .webmanifest
              AddType application/octet-stream .onnx
              AddType application/octet-stream .data
              AddType application/json .onnx.json
          </IfModule>

          # ====================================
          # 5. SECURITY - BLOCK ACCESS TO SENSITIVE FILES
          # ====================================

          # Block access to hidden files (starting with .)
          <FilesMatch "^\.">
              Require all denied
          </FilesMatch>

          # Disable directory listing
          Options -Indexes

          # Default document
          DirectoryIndex index.html
          EOF

      - name: üì¶ Sync files via lftp
        run: |
          # Installer lftp si n√©cessaire
          sudo apt-get update -qq
          sudo apt-get install -y lftp

          echo "üöÄ D√©ploiement via FTP vers ${{ secrets.O2SWITCH_FTP_HOST }}"

          lftp -c "
            set ftp:ssl-allow no;
            set net:timeout 10;
            set net:max-retries 3;
            set net:reconnect-interval-base 5;
            open -u ${{ secrets.O2SWITCH_FTP_USERNAME }},${{ secrets.O2SWITCH_FTP_PASSWORD }} ${{ secrets.O2SWITCH_FTP_HOST }};
            mirror --reverse --delete --verbose --parallel=10 dist-offline/ ${{ secrets.O2SWITCH_PATH_OFFLINE }}/;
            bye;
          "

      - name: ‚úÖ Deployment complete
        run: |
          echo "‚úÖ Offline build deployed successfully!"
          echo "üåê URL: https://app.repet.ecanasso.org"
          echo "üì¶ Build size: $(du -sh dist-offline/ | cut -f1)"
          echo "üìÅ Deployed to: ${{ secrets.O2SWITCH_PATH_OFFLINE }}"

  # ==========================================
  # JOB 2: Build et d√©ployer ONLINE
  # ==========================================
  deploy-online:
    name: üåê Deploy Online Build
    runs-on: ubuntu-latest

    steps:
      - name: ‚úÖ Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì• Install dependencies
        run: npm ci

      - name: üîç Type check
        run: npm run type-check

      - name: üßπ Lint
        run: npm run lint

      - name: üèóÔ∏è Build ONLINE
        run: npm run build:online
        env:
          NODE_ENV: production

      - name: üìä Check build size
        run: |
          echo "üì¶ Online build size:"
          du -sh dist-online/
          echo ""
          echo "Top 10 largest files/folders:"
          du -sh dist-online/* | sort -rh | head -10

      - name: üìù Copy .htaccess for online build
        run: |
          cat > dist-online/.htaccess << 'EOF'
          # .htaccess for R√©p√©t Online Build (ios.repet.ecanasso.org)
          # Lightweight build - voices loaded from CDN on demand

          # ====================================
          # 1. SECURITY & WASM/PWA HEADERS
          # ====================================

          <IfModule mod_headers.c>
              # Required headers for SharedArrayBuffer and threaded WASM
              Header set Cross-Origin-Embedder-Policy "credentialless"
              Header set Cross-Origin-Opener-Policy "same-origin"

              # General security headers
              Header set X-Content-Type-Options "nosniff"
              Header set X-Frame-Options "DENY"
              Header set X-XSS-Protection "1; mode=block"
              Header set Referrer-Policy "strict-origin-when-cross-origin"

              # Service Worker - no cache, always fresh
              <FilesMatch "sw\.js$">
                  Header set Cache-Control "public, max-age=0, must-revalidate"
                  Header set Service-Worker-Allowed "/"
              </FilesMatch>

              # Workbox - no cache
              <FilesMatch "workbox-.*\.js$">
                  Header set Cache-Control "public, max-age=0, must-revalidate"
              </FilesMatch>

              # PWA Manifest
              <FilesMatch "manifest\.webmanifest$">
                  Header set Content-Type "application/manifest+json"
                  Header set Cache-Control "public, max-age=86400"
              </FilesMatch>

              # Aggressive cache for hashed assets (immutable)
              <FilesMatch "\.(js|css|woff2|png|jpg|svg)$">
                  Header set Cache-Control "public, max-age=31536000, immutable"
              </FilesMatch>

              # WASM files
              <FilesMatch "\.wasm$">
                  Header set Content-Type "application/wasm"
                  Header set Cache-Control "public, max-age=31536000, immutable"
              </FilesMatch>

              # MJS (ES Module) files
              <FilesMatch "\.mjs$">
                  Header set Content-Type "application/javascript"
                  Header set Cache-Control "public, max-age=31536000, immutable"
              </FilesMatch>

              # Data files for WASM
              <FilesMatch "\.data$">
                  Header set Content-Type "application/octet-stream"
                  Header set Cache-Control "public, max-age=31536000, immutable"
              </FilesMatch>
          </IfModule>

          # ====================================
          # 2. COMPRESSION (GZIP/BROTLI)
          # ====================================

          <IfModule mod_deflate.c>
              AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript
              AddOutputFilterByType DEFLATE application/javascript application/json
              AddOutputFilterByType DEFLATE application/manifest+json
          </IfModule>

          # ====================================
          # 3. SINGLE PAGE APPLICATION (SPA)
          # ====================================

          <IfModule mod_rewrite.c>
              RewriteEngine On
              RewriteBase /

              # Don't rewrite files that exist
              RewriteCond %{REQUEST_FILENAME} !-f
              RewriteCond %{REQUEST_FILENAME} !-d

              # Redirect all routes to index.html (SPA routing)
              RewriteRule ^ index.html [L]
          </IfModule>

          # ====================================
          # 4. MIME TYPES
          # ====================================

          <IfModule mod_mime.c>
              AddType application/wasm .wasm
              AddType application/javascript .mjs
              AddType application/manifest+json .webmanifest
              AddType application/octet-stream .data
          </IfModule>

          # ====================================
          # 5. SECURITY - BLOCK ACCESS TO SENSITIVE FILES
          # ====================================

          # Block access to hidden files (starting with .)
          <FilesMatch "^\.">
              Require all denied
          </FilesMatch>

          # Disable directory listing
          Options -Indexes

          # Default document
          DirectoryIndex index.html
          EOF

      - name: üì¶ Sync files via lftp
        run: |
          # Installer lftp si n√©cessaire
          sudo apt-get update -qq
          sudo apt-get install -y lftp

          echo "üöÄ D√©ploiement via FTP vers ${{ secrets.O2SWITCH_FTP_HOST }}"

          lftp -c "
            set ftp:ssl-allow no;
            set net:timeout 10;
            set net:max-retries 3;
            set net:reconnect-interval-base 5;
            open -u ${{ secrets.O2SWITCH_FTP_USERNAME }},${{ secrets.O2SWITCH_FTP_PASSWORD }} ${{ secrets.O2SWITCH_FTP_HOST }};
            mirror --reverse --delete --verbose --parallel=10 dist-online/ ${{ secrets.O2SWITCH_PATH_ONLINE }}/;
            bye;
          "

      - name: ‚úÖ Deployment complete
        run: |
          echo "‚úÖ Online build deployed successfully!"
          echo "üåê URL: https://ios.repet.ecanasso.org"
          echo "üì¶ Build size: $(du -sh dist-online/ | cut -f1)"
          echo "üìÅ Deployed to: ${{ secrets.O2SWITCH_PATH_ONLINE }}"
