name: Deploy to O2switch

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  # ==========================================
  # JOB 1: Build et d√©ployer OFFLINE
  # ==========================================
  deploy-offline:
    name: üöÄ Deploy Offline Build
    runs-on: ubuntu-latest

    steps:
      - name: ‚úÖ Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì• Install dependencies
        run: npm ci

      - name: üîç Type check
        run: npm run type-check

      - name: üßπ Lint
        run: npm run lint

      - name: üèóÔ∏è Build OFFLINE
        run: npm run build:offline
        env:
          NODE_ENV: production

      - name: üìä Check build size
        run: |
          echo "üì¶ Offline build size:"
          du -sh dist-offline/
          echo ""
          echo "Top 10 largest files/folders:"
          du -sh dist-offline/* | sort -rh | head -10

      - name: üìù Copy .htaccess for offline build
        run: |
          cat > dist-offline/.htaccess << 'EOF'
          # .htaccess for R√©p√©t Offline Build (app.repet.ecanasso.org)
          # This configuration ensures proper headers for PWA, WASM, and security

          # ====================================
          # 1. SECURITY & WASM/PWA HEADERS
          # ====================================

          <IfModule mod_headers.c>
              # Required headers for SharedArrayBuffer and threaded WASM
              Header set Cross-Origin-Embedder-Policy "credentialless"
              Header set Cross-Origin-Opener-Policy "same-origin"

              # General security headers
              Header set X-Content-Type-Options "nosniff"
              Header set X-Frame-Options "DENY"
              Header set X-XSS-Protection "1; mode=block"
              Header set Referrer-Policy "strict-origin-when-cross-origin"

              # Service Worker - no cache, always fresh
              <FilesMatch "sw\.js$">
                  Header set Cache-Control "public, max-age=0, must-revalidate"
                  Header set Service-Worker-Allowed "/"
              </FilesMatch>

              # Workbox - no cache
              <FilesMatch "workbox-.*\.js$">
                  Header set Cache-Control "public, max-age=0, must-revalidate"
              </FilesMatch>

              # PWA Manifest
              <FilesMatch "manifest\.webmanifest$">
                  Header set Content-Type "application/manifest+json"
                  Header set Cache-Control "public, max-age=86400"
              </FilesMatch>

              # Aggressive cache for hashed assets (immutable)
              <FilesMatch "\.(js|css|woff2|png|jpg|svg)$">
                  Header set Cache-Control "public, max-age=31536000, immutable"
              </FilesMatch>

              # Cache for voice models (.onnx files - large files)
              <FilesMatch "\.onnx$">
                  Header set Content-Type "application/octet-stream"
                  Header set Cache-Control "public, max-age=31536000, immutable"
              </FilesMatch>

              # Cache for voice model configs
              <FilesMatch "\.onnx\.json$">
                  Header set Content-Type "application/json"
                  Header set Cache-Control "public, max-age=31536000, immutable"
              </FilesMatch>

              # WASM files
              <FilesMatch "\.wasm$">
                  Header set Content-Type "application/wasm"
                  Header set Cache-Control "public, max-age=31536000, immutable"
              </FilesMatch>

              # MJS (ES Module) files
              <FilesMatch "\.mjs$">
                  Header set Content-Type "application/javascript"
                  Header set Cache-Control "public, max-age=31536000, immutable"
              </FilesMatch>

              # Data files for WASM
              <FilesMatch "\.data$">
                  Header set Content-Type "application/octet-stream"
                  Header set Cache-Control "public, max-age=31536000, immutable"
              </FilesMatch>
          </IfModule>

          # ====================================
          # 2. COMPRESSION (GZIP/BROTLI)
          # ====================================

          <IfModule mod_deflate.c>
              AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript
              AddOutputFilterByType DEFLATE application/javascript application/json
              AddOutputFilterByType DEFLATE application/manifest+json
              # Note: WASM compression is handled by the server if mod_brotli is enabled
          </IfModule>

          # ====================================
          # 3. SINGLE PAGE APPLICATION (SPA)
          # ====================================

          <IfModule mod_rewrite.c>
              RewriteEngine On
              RewriteBase /

              # Don't rewrite files that exist
              RewriteCond %{REQUEST_FILENAME} !-f
              RewriteCond %{REQUEST_FILENAME} !-d

              # Redirect all routes to index.html (SPA routing)
              RewriteRule ^ index.html [L]
          </IfModule>

          # ====================================
          # 4. MIME TYPES
          # ====================================

          <IfModule mod_mime.c>
              AddType application/wasm .wasm
              AddType application/javascript .mjs
              AddType application/manifest+json .webmanifest
              AddType application/octet-stream .onnx
              AddType application/octet-stream .data
              AddType application/json .onnx.json
          </IfModule>

          # ====================================
          # 5. SECURITY - BLOCK ACCESS TO SENSITIVE FILES
          # ====================================

          # Block access to hidden files (starting with .)
          <FilesMatch "^\.">
              Require all denied
          </FilesMatch>

          # Disable directory listing
          Options -Indexes

          # Default document
          DirectoryIndex index.html
          EOF

      - name: üîê Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Cr√©er la cl√© SSH
          echo "${{ secrets.O2SWITCH_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # V√©rifier que la cl√© est valide
          echo "üîç V√©rification de la cl√© SSH..."
          ssh-keygen -l -f ~/.ssh/deploy_key || {
            echo "‚ùå Erreur: La cl√© SSH est invalide"
            exit 1
          }

          # Scanner la cl√© de l'h√¥te (avec timeout et retry)
          echo "üîç Scan de l'h√¥te SSH: ${{ secrets.O2SWITCH_HOST }}:${{ secrets.O2SWITCH_PORT }}"

          # Essayer avec timeout
          timeout 30 ssh-keyscan -p ${{ secrets.O2SWITCH_PORT }} -H ${{ secrets.O2SWITCH_HOST }} >> ~/.ssh/known_hosts 2>&1 || {
            echo "‚ö†Ô∏è ssh-keyscan a √©chou√©, on continue avec StrictHostKeyChecking=no"
            # Cr√©er un fichier known_hosts vide
            touch ~/.ssh/known_hosts
          }

          chmod 644 ~/.ssh/known_hosts

          # Test de connexion SSH
          echo "üß™ Test de connexion SSH..."
          ssh -i ~/.ssh/deploy_key \
              -p ${{ secrets.O2SWITCH_PORT }} \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              ${{ secrets.O2SWITCH_USERNAME }}@${{ secrets.O2SWITCH_HOST }} \
              "echo '‚úÖ Connexion SSH r√©ussie'" || {
            echo "‚ùå Erreur: Impossible de se connecter en SSH"
            echo "V√©rifiez:"
            echo "  - O2SWITCH_HOST: ${{ secrets.O2SWITCH_HOST }}"
            echo "  - O2SWITCH_PORT: ${{ secrets.O2SWITCH_PORT }}"
            echo "  - O2SWITCH_USERNAME: ${{ secrets.O2SWITCH_USERNAME }}"
            echo "  - La cl√© SSH est autoris√©e sur le serveur"
            exit 1
          }

      - name: üöÄ Deploy via rsync
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.O2SWITCH_PORT }} -o StrictHostKeyChecking=no" \
            dist-offline/ \
            ${{ secrets.O2SWITCH_USERNAME }}@${{ secrets.O2SWITCH_HOST }}:${{ secrets.O2SWITCH_PATH_OFFLINE }}/

      - name: ‚úÖ Deployment complete
        run: |
          echo "‚úÖ Offline build deployed successfully!"
          echo "üåê URL: https://app.repet.ecanasso.org"
          echo "üì¶ Build size: $(du -sh dist-offline/ | cut -f1)"
          echo "üìÅ Deployed to: ${{ secrets.O2SWITCH_PATH_OFFLINE }}"

  # ==========================================
  # JOB 2: Build et d√©ployer ONLINE
  # ==========================================
  deploy-online:
    name: üåê Deploy Online Build
    runs-on: ubuntu-latest

    steps:
      - name: ‚úÖ Checkout code
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì• Install dependencies
        run: npm ci

      - name: üîç Type check
        run: npm run type-check

      - name: üßπ Lint
        run: npm run lint

      - name: üèóÔ∏è Build ONLINE
        run: npm run build:online
        env:
          NODE_ENV: production

      - name: üìä Check build size
        run: |
          echo "üì¶ Online build size:"
          du -sh dist-online/
          echo ""
          echo "Top 10 largest files/folders:"
          du -sh dist-online/* | sort -rh | head -10

      - name: üìù Copy .htaccess for online build
        run: |
          cat > dist-online/.htaccess << 'EOF'
          # .htaccess for R√©p√©t Online Build (ios.repet.ecanasso.org)
          # Lightweight build - voices loaded from CDN on demand

          # ====================================
          # 1. SECURITY & WASM/PWA HEADERS
          # ====================================

          <IfModule mod_headers.c>
              # Required headers for SharedArrayBuffer and threaded WASM
              Header set Cross-Origin-Embedder-Policy "credentialless"
              Header set Cross-Origin-Opener-Policy "same-origin"

              # General security headers
              Header set X-Content-Type-Options "nosniff"
              Header set X-Frame-Options "DENY"
              Header set X-XSS-Protection "1; mode=block"
              Header set Referrer-Policy "strict-origin-when-cross-origin"

              # Service Worker - no cache, always fresh
              <FilesMatch "sw\.js$">
                  Header set Cache-Control "public, max-age=0, must-revalidate"
                  Header set Service-Worker-Allowed "/"
              </FilesMatch>

              # Workbox - no cache
              <FilesMatch "workbox-.*\.js$">
                  Header set Cache-Control "public, max-age=0, must-revalidate"
              </FilesMatch>

              # PWA Manifest
              <FilesMatch "manifest\.webmanifest$">
                  Header set Content-Type "application/manifest+json"
                  Header set Cache-Control "public, max-age=86400"
              </FilesMatch>

              # Aggressive cache for hashed assets (immutable)
              <FilesMatch "\.(js|css|woff2|png|jpg|svg)$">
                  Header set Cache-Control "public, max-age=31536000, immutable"
              </FilesMatch>

              # WASM files
              <FilesMatch "\.wasm$">
                  Header set Content-Type "application/wasm"
                  Header set Cache-Control "public, max-age=31536000, immutable"
              </FilesMatch>

              # MJS (ES Module) files
              <FilesMatch "\.mjs$">
                  Header set Content-Type "application/javascript"
                  Header set Cache-Control "public, max-age=31536000, immutable"
              </FilesMatch>

              # Data files for WASM
              <FilesMatch "\.data$">
                  Header set Content-Type "application/octet-stream"
                  Header set Cache-Control "public, max-age=31536000, immutable"
              </FilesMatch>
          </IfModule>

          # ====================================
          # 2. COMPRESSION (GZIP/BROTLI)
          # ====================================

          <IfModule mod_deflate.c>
              AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript
              AddOutputFilterByType DEFLATE application/javascript application/json
              AddOutputFilterByType DEFLATE application/manifest+json
          </IfModule>

          # ====================================
          # 3. SINGLE PAGE APPLICATION (SPA)
          # ====================================

          <IfModule mod_rewrite.c>
              RewriteEngine On
              RewriteBase /

              # Don't rewrite files that exist
              RewriteCond %{REQUEST_FILENAME} !-f
              RewriteCond %{REQUEST_FILENAME} !-d

              # Redirect all routes to index.html (SPA routing)
              RewriteRule ^ index.html [L]
          </IfModule>

          # ====================================
          # 4. MIME TYPES
          # ====================================

          <IfModule mod_mime.c>
              AddType application/wasm .wasm
              AddType application/javascript .mjs
              AddType application/manifest+json .webmanifest
              AddType application/octet-stream .data
          </IfModule>

          # ====================================
          # 5. SECURITY - BLOCK ACCESS TO SENSITIVE FILES
          # ====================================

          # Block access to hidden files (starting with .)
          <FilesMatch "^\.">
              Require all denied
          </FilesMatch>

          # Disable directory listing
          Options -Indexes

          # Default document
          DirectoryIndex index.html
          EOF

      - name: üîê Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Cr√©er la cl√© SSH
          echo "${{ secrets.O2SWITCH_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # V√©rifier que la cl√© est valide
          echo "üîç V√©rification de la cl√© SSH..."
          ssh-keygen -l -f ~/.ssh/deploy_key || {
            echo "‚ùå Erreur: La cl√© SSH est invalide"
            exit 1
          }

          # Scanner la cl√© de l'h√¥te (avec timeout et retry)
          echo "üîç Scan de l'h√¥te SSH: ${{ secrets.O2SWITCH_HOST }}:${{ secrets.O2SWITCH_PORT }}"

          # Essayer avec timeout
          timeout 30 ssh-keyscan -p ${{ secrets.O2SWITCH_PORT }} -H ${{ secrets.O2SWITCH_HOST }} >> ~/.ssh/known_hosts 2>&1 || {
            echo "‚ö†Ô∏è ssh-keyscan a √©chou√©, on continue avec StrictHostKeyChecking=no"
            # Cr√©er un fichier known_hosts vide
            touch ~/.ssh/known_hosts
          }

          chmod 644 ~/.ssh/known_hosts

          # Test de connexion SSH
          echo "üß™ Test de connexion SSH..."
          ssh -i ~/.ssh/deploy_key \
              -p ${{ secrets.O2SWITCH_PORT }} \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              -o BatchMode=yes \
              ${{ secrets.O2SWITCH_USERNAME }}@${{ secrets.O2SWITCH_HOST }} \
              "echo '‚úÖ Connexion SSH r√©ussie'" || {
            echo "‚ùå Erreur: Impossible de se connecter en SSH"
            echo "V√©rifiez:"
            echo "  - O2SWITCH_HOST: ${{ secrets.O2SWITCH_HOST }}"
            echo "  - O2SWITCH_PORT: ${{ secrets.O2SWITCH_PORT }}"
            echo "  - O2SWITCH_USERNAME: ${{ secrets.O2SWITCH_USERNAME }}"
            echo "  - La cl√© SSH est autoris√©e sur le serveur"
            exit 1
          }

      - name: üöÄ Deploy via rsync
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.O2SWITCH_PORT }} -o StrictHostKeyChecking=no" \
            dist-online/ \
            ${{ secrets.O2SWITCH_USERNAME }}@${{ secrets.O2SWITCH_HOST }}:${{ secrets.O2SWITCH_PATH_ONLINE }}/

      - name: ‚úÖ Deployment complete
        run: |
          echo "‚úÖ Online build deployed successfully!"
          echo "üåê URL: https://ios.repet.ecanasso.org"
          echo "üì¶ Build size: $(du -sh dist-online/ | cut -f1)"
          echo "üìÅ Deployed to: ${{ secrets.O2SWITCH_PATH_ONLINE }}"
