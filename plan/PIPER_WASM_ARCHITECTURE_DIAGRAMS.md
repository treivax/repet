# ğŸ¨ Diagrammes d'Architecture : IntÃ©gration Piper-WASM

**Projet** : RÃ©pÃ©t  
**Branche** : `piper-wasm`  
**Version** : 1.0

---

## ğŸ“Š Vue d'Ensemble du SystÃ¨me

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         RÃ‰PÃ‰T APPLICATION                        â”‚
â”‚                     (React 18 + TypeScript)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   ReaderScreen      â”‚   â”‚  SettingsScreen    â”‚
         â”‚  (Lecture Texte)    â”‚   â”‚   (Configuration)  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                        â”‚
                    â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   TTSProviderManager          â”‚
         â”‚   (Orchestrateur Central)     â”‚
         â”‚                                â”‚
         â”‚  - SÃ©lection provider actif   â”‚
         â”‚  - Routing des commandes      â”‚
         â”‚  - Gestion du cache           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebSpeechProviderâ”‚   â”‚ PiperWASMProviderâ”‚
â”‚                  â”‚   â”‚                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Web Speech   â”‚ â”‚   â”‚ â”‚ Piper WASM   â”‚ â”‚
â”‚ â”‚ API (native) â”‚ â”‚   â”‚ â”‚ Module       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                  â”‚   â”‚                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ VoiceManager â”‚ â”‚   â”‚ â”‚ Model Cache  â”‚ â”‚
â”‚ â”‚ TTSEngine    â”‚ â”‚   â”‚ â”‚ (IndexedDB)  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Flux de DonnÃ©es : Lecture Audio

### ScÃ©nario 1 : PremiÃ¨re Lecture avec Piper

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Utilisateur â”‚
â”‚ clique Play â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ReaderScreen                         â”‚
â”‚  â†’ getSelectedVoice()                â”‚
â”‚  â†’ ttsProviderManager.speak(...)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TTSProviderManager                             â”‚
â”‚  1. VÃ©rifie provider actif (piper-wasm)       â”‚
â”‚  2. GÃ©nÃ¨re cache key (hash text + options)    â”‚
â”‚  3. VÃ©rifie AudioCacheService                 â”‚
â”‚  4. Cache MISS â†’ dÃ©lÃ¨gue Ã  PiperWASMProvider  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PiperWASMProvider                            â”‚
â”‚  1. VÃ©rifie si modÃ¨le chargÃ© en mÃ©moire      â”‚
â”‚  2. NON â†’ downloadAndLoadModel()             â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚     â”‚ TÃ©lÃ©chargement ModÃ¨le              â”‚   â”‚
â”‚     â”‚ - Fetch depuis CDN                 â”‚   â”‚
â”‚     â”‚ - Progress tracking (events)       â”‚   â”‚
â”‚     â”‚ - Store dans loadedModels Map      â”‚   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  3. piperModule.synthesize(text, options)    â”‚
â”‚  4. GÃ©nÃ¨re AudioBuffer (WAV)                 â”‚
â”‚  5. CrÃ©e Blob â†’ URL.createObjectURL()        â”‚
â”‚  6. Cache dans AudioCacheService             â”‚
â”‚  7. Retourne HTMLAudioElement                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AudioCacheService                    â”‚
â”‚  â†’ Stocke dans IndexedDB             â”‚
â”‚  â†’ Key: audio_[hash]                 â”‚
â”‚  â†’ Value: { blob, metadata }         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ReaderScreen                         â”‚
â”‚  â†’ audio.play()                      â”‚
â”‚  â†’ events.onStart()                  â”‚
â”‚  â†’ events.onEnd() (quand terminÃ©)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ScÃ©nario 2 : Lecture Suivante (Cache HIT)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Utilisateur â”‚
â”‚ clique Play â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ReaderScreen                         â”‚
â”‚  â†’ ttsProviderManager.speak(...)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TTSProviderManager                             â”‚
â”‚  1. GÃ©nÃ¨re cache key                           â”‚
â”‚  2. VÃ©rifie AudioCacheService                  â”‚
â”‚  3. Cache HIT âœ…                               â”‚
â”‚  4. Retourne audio directement (< 100ms)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ReaderScreen                         â”‚
â”‚  â†’ audio.play() (INSTANTANÃ‰)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ Architecture des Providers

### Interface TTSProvider (Contrat)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              <<interface>>                    â”‚
â”‚              TTSProvider                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + type: TTSProviderType                       â”‚
â”‚ + name: string                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + initialize(): Promise<void>                 â”‚
â”‚ + checkAvailability(): Promise<Availability>  â”‚
â”‚ + getVoices(): Promise<VoiceDescriptor[]>     â”‚
â”‚ + synthesize(...): Promise<SynthesisResult>   â”‚
â”‚ + stop(): void                                â”‚
â”‚ + pause?(): void                              â”‚
â”‚ + resume?(): void                             â”‚
â”‚ + dispose(): Promise<void>                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â–³
                      â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WebSpeechProviderâ”‚     â”‚ PiperWASMProviderâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - engine         â”‚     â”‚ - piperModule    â”‚
â”‚ - synth          â”‚     â”‚ - loadedModels   â”‚
â”‚                  â”‚     â”‚ - currentAudio   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + initialize()   â”‚     â”‚ + initialize()   â”‚
â”‚ + synthesize()   â”‚     â”‚ + synthesize()   â”‚
â”‚ + stop()         â”‚     â”‚ + stop()         â”‚
â”‚ + pause()        â”‚     â”‚ + pause()        â”‚
â”‚ + resume()       â”‚     â”‚ + resume()       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ Structure de Stockage

### IndexedDB : AudioCache

```
Database: RepetAudioCache (v1)
â”‚
â””â”€â”€â”€ ObjectStore: audioCache
     â”‚
     â”œâ”€â”€â”€ Key: "audio_abc123" (cache key)
     â”‚    Value: {
     â”‚      key: "audio_abc123",
     â”‚      audioBlob: Blob (WAV),
     â”‚      createdAt: 1704067200000,
     â”‚      accessCount: 5,
     â”‚      lastAccess: 1704153600000
     â”‚    }
     â”‚
     â”œâ”€â”€â”€ Key: "audio_def456"
     â”‚    Value: { ... }
     â”‚
     â””â”€â”€â”€ Key: "audio_ghi789"
          Value: { ... }
```

### LocalStorage : Configuration TTS

```
Key: "repet-tts-config"
Value: {
  "state": {
    "selectedProvider": "piper-wasm",
    // Futures options...
  },
  "version": 1
}
```

---

## ğŸ”€ Flux de Changement de Provider

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Utilisateur         â”‚
â”‚ sÃ©lectionne "Piper" â”‚
â”‚ dans Settings       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TTSEngineSelector                  â”‚
â”‚  â†’ handleProviderChange('piper')   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ttsProviderManager                           â”‚
â”‚  1. stop() sur provider actuel               â”‚
â”‚  2. activeProvider = null                    â”‚
â”‚  3. provider = providers.get('piper-wasm')   â”‚
â”‚  4. provider.initialize()                    â”‚
â”‚  5. activeProvider = provider                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ useTTSConfigStore                  â”‚
â”‚  â†’ setProvider('piper-wasm')       â”‚
â”‚  â†’ Persist dans localStorage       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ App.tsx (useEffect)                â”‚
â”‚  â†’ DÃ©tecte changement              â”‚
â”‚  â†’ RÃ©initialise TTS                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ Composants UI

### SettingsScreen â†’ TTSEngineSelector

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SettingsScreen                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ“¢ SynthÃ¨se Vocale                         â”‚ â”‚
â”‚ â”‚                                            â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚ TTSEngineSelector                      â”‚ â”‚ â”‚
â”‚ â”‚ â”‚                                        â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ Moteur de gÃ©nÃ©ration des voix          â”‚ â”‚ â”‚
â”‚ â”‚ â”‚                                        â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â—‹ Voix SystÃ¨me (Navigateur)           â”‚ â”‚ â”‚
â”‚ â”‚ â”‚   Utilise les voix systÃ¨me...          â”‚ â”‚ â”‚
â”‚ â”‚ â”‚                                        â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ â— Piper (Voix Hors-ligne) [RecommandÃ©]â”‚ â”‚ â”‚
â”‚ â”‚ â”‚   Voix de haute qualitÃ©...             â”‚ â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â”‚                                            â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚ VoiceSelector (existant)               â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ Choix de la voix : [Siwis Femme â–¼]    â”‚ â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â”‚                                            â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚ â”‚ â”‚ PiperModelManager (optionnel)          â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ Espace utilisÃ© : 12 MB                 â”‚ â”‚ â”‚
â”‚ â”‚ â”‚ [Vider le cache]                       â”‚ â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ DÃ©pendances et Modules

### Avant (Existant)

```
src/core/tts/
â”œâ”€â”€ engine.ts          â†’ TTSEngine (Web Speech API)
â”œâ”€â”€ voice-manager.ts   â†’ VoiceManager (systÃ¨me)
â”œâ”€â”€ queue.ts           â†’ SpeechQueue
â”œâ”€â”€ types.ts           â†’ Types TTS
â””â”€â”€ readingModes.ts    â†’ Modes de lecture
```

### AprÃ¨s (Piper-WASM)

```
src/core/tts/
â”œâ”€â”€ provider/           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   â”œâ”€â”€ types.ts       â”‚ NOUVEAU         â”‚
â”‚   â”œâ”€â”€ TTSProviderManager.ts  â”‚         â”‚
â”‚   â”œâ”€â”€ WebSpeechProvider.ts   â”‚         â”‚
â”‚   â”œâ”€â”€ PiperWASMProvider.ts   â”‚         â”‚
â”‚   â””â”€â”€ AudioCacheService.ts   â”‚         â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”œâ”€â”€ engine.ts          (inchangÃ©)
â”œâ”€â”€ voice-manager.ts   (inchangÃ©)
â”œâ”€â”€ queue.ts           (inchangÃ©)
â”œâ”€â”€ types.ts           (inchangÃ©)
â”œâ”€â”€ readingModes.ts    (inchangÃ©)
â””â”€â”€ index.ts           (exports modifiÃ©s)
```

---

## ğŸ”„ Cycle de Vie d'un Provider

### Initialisation App

```
App Mount
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ useTTSConfigStore                   â”‚
â”‚  â†’ selectedProvider = 'piper-wasm'  â”‚
â”‚    (depuis localStorage)            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ttsProviderManager.initialize('piper-wasm')  â”‚
â”‚                                              â”‚
â”‚ 1. providers.get('piper-wasm')              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚    â”‚ PiperWASMProvider                â”‚     â”‚
â”‚    â”‚  â†’ checkAvailability()           â”‚     â”‚
â”‚    â”‚    âœ… WebAssembly supported      â”‚     â”‚
â”‚    â”‚  â†’ initialize()                  â”‚     â”‚
â”‚    â”‚    â†’ import('piper-tts-wasm')    â”‚     â”‚
â”‚    â”‚    â†’ piperModule.initialize()    â”‚     â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                              â”‚
â”‚ 2. activeProvider = piperProvider           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
   âœ… App Ready
```

### Nettoyage (App Unmount)

```
App Unmount
   â”‚
   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ttsProviderManager.dispose()     â”‚
â”‚                                  â”‚
â”‚ for each provider:               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚ provider.dispose()         â”‚ â”‚
â”‚   â”‚  â†’ stop()                  â”‚ â”‚
â”‚   â”‚  â†’ clear resources         â”‚ â”‚
â”‚   â”‚  â†’ free WASM memory        â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                  â”‚
â”‚ activeProvider = null            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª ScÃ©narios de Test

### Test 1 : Premier Lancement (DÃ©faut Piper)

```
Ã‰tat Initial:
  localStorage: vide
  IndexedDB: vide

Action:
  1. Ouvrir app
  2. Importer piÃ¨ce
  3. Cliquer Play

RÃ©sultat Attendu:
  âœ… Piper sÃ©lectionnÃ© par dÃ©faut
  âœ… TÃ©lÃ©chargement modÃ¨le (avec progression)
  âœ… Audio gÃ©nÃ©rÃ© et jouÃ©
  âœ… Audio mis en cache
  âœ… localStorage: { selectedProvider: 'piper-wasm' }
```

### Test 2 : Changement de Provider

```
Ã‰tat Initial:
  Provider actif: Piper

Action:
  1. Settings â†’ SÃ©lectionner "Natif Device"
  2. Retour Ã  lecture
  3. Cliquer Play

RÃ©sultat Attendu:
  âœ… Provider change instantanÃ©ment
  âœ… Web Speech API utilisÃ©
  âœ… Pas de tÃ©lÃ©chargement
  âœ… localStorage: { selectedProvider: 'web-speech' }
```

### Test 3 : Cache Hit

```
Ã‰tat Initial:
  Provider: Piper
  Cache: contient audio pour rÃ©plique X

Action:
  1. Lire rÃ©plique X
  2. Attendre fin
  3. Relire rÃ©plique X

RÃ©sultat Attendu:
  âœ… 1Ã¨re lecture: gÃ©nÃ©ration (2s)
  âœ… 2e lecture: cache hit (< 100ms)
  âœ… fromCache = true
  âœ… accessCount incrÃ©mentÃ© dans IndexedDB
```

---

## ğŸ“Š MÃ©triques et Monitoring

### Points de Mesure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Performance Metrics                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ Init Time (provider load)          â”‚
â”‚ â€¢ Model Download Time                â”‚
â”‚ â€¢ Audio Generation Time              â”‚
â”‚ â€¢ Cache Hit Rate                     â”‚
â”‚ â€¢ Total Storage Used (IndexedDB)     â”‚
â”‚ â€¢ Memory Usage (WASM heap)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Console Logging (Dev)

```typescript
// Dans PiperWASMProvider.synthesize()
console.group('ğŸ™ï¸ Piper Synthesis');
console.log('Text:', text.substring(0, 50) + '...');
console.log('Voice:', options.voiceId);
console.log('Cache Key:', cacheKey);
console.log('Cache Hit:', !!cachedBlob);
console.log('Duration:', duration + 'ms');
console.groupEnd();
```

---

## ğŸ” SÃ©curitÃ© et ConfidentialitÃ©

### DonnÃ©es Sensibles

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DonnÃ©es StockÃ©es Localement             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… Audio gÃ©nÃ©rÃ© (cache)                 â”‚
â”‚    â†’ Blob WAV, pas de texte source      â”‚
â”‚    â†’ Peut Ãªtre vidÃ© par l'utilisateur   â”‚
â”‚                                         â”‚
â”‚ âœ… ModÃ¨les Piper (WASM)                 â”‚
â”‚    â†’ Public, open-source                â”‚
â”‚    â†’ Pas de donnÃ©es personnelles        â”‚
â”‚                                         â”‚
â”‚ âœ… Configuration (localStorage)         â”‚
â”‚    â†’ Provider sÃ©lectionnÃ© uniquement    â”‚
â”‚    â†’ Pas de donnÃ©es sensibles           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Aucune donnÃ©e envoyÃ©e au serveur âœ…
Fonctionne 100% hors-ligne âœ…
```

---

## ğŸš€ DÃ©ploiement et Build

### Build Pipeline

```
npm run build
   â”‚
   â”œâ”€â†’ TypeScript Compilation
   â”‚     â””â”€â†’ Check types (strict)
   â”‚
   â”œâ”€â†’ Vite Bundle
   â”‚     â”œâ”€â†’ Minify JS
   â”‚     â”œâ”€â†’ Optimize CSS
   â”‚     â””â”€â†’ Generate manifest.json
   â”‚
   â”œâ”€â†’ PWA Assets
   â”‚     â”œâ”€â†’ Service Worker
   â”‚     â””â”€â†’ Icons
   â”‚
   â””â”€â†’ dist/
       â”œâ”€â”€â”€ index.html
       â”œâ”€â”€â”€ assets/
       â”‚    â”œâ”€â”€ index.[hash].js
       â”‚    â”œâ”€â”€ piper-wasm.[hash].js  â† NOUVEAU
       â”‚    â””â”€â”€ ...
       â”œâ”€â”€â”€ manifest.json
       â””â”€â”€â”€ sw.js
```

### Service Worker (Cache Strategy)

```
Service Worker

Install:
  â†’ Cache static assets
  â†’ Cache piper-wasm module

Fetch:
  â†’ HTML: Network-first
  â†’ JS/CSS: Cache-first
  â†’ Piper Models: Cache-first (CDN)
  â†’ Audio: IndexedDB (handled by app)
```

---

**Fin des Diagrammes**

Ce document fournit une vue visuelle complÃ¨te de l'architecture Piper-WASM pour faciliter la comprÃ©hension et l'implÃ©mentation.